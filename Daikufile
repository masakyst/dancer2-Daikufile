
use YAML;
use Template;

# add parameters, enviroments/production.yml
# deploy app server directory
#appdir: /home/masakyst/app/HelloWorld
#user: masakyst
#group: masakyst
#psgifile: app.psgi
#port: 5000
#perl_version: perl-5.18
#perlbrew_home: /home/masakyst


namespace dancer2 => sub {
    desc 'dancer2 scaffold';
    task scaffold => sub {
    };
};

namespace create => sub {

    desc 'create app.psgi';
    task psgi => sub {
        sh q(cp ./bin/app.pl app.psgi);
        sh q(chmod 0644 app.psgi);
        sh q(perl -pi -e 's/\.\.\/lib/lib/g' app.psgi);
        unless (-e 'cpanfile') {
            sh q(curl -s -o cpanfile https://raw.githubusercontent.com/masakyst/dancer2-Daikufile/master/cpanfile);
        } 
    };

    desc 'create initd script';
    task initd => sub {
        my %merged_config = (
            %{ YAML::LoadFile('config.yml') },
            %{ YAML::LoadFile('environments/production.yml') }
        );
        my $tt = Template->new;
        ($merged_config{prog_name} = lc $merged_config{appname}) =~ s/::/\-/;
        {
            unless (-e 'init.d/script.tt') {
                sh q(mkdir -p init.d);
                sh q(curl -s -o init.d/script.tt https://raw.githubusercontent.com/masakyst/centos-initd-psgi-template/master/script.tt);
            }
            my $output_script;
            $tt->process('init.d/script.tt', \%merged_config, \$output_script);
            open my $fh, '>', 'init.d/'.$merged_config{appname} or die qw/Can't open file: $!/;
            print $fh $output_script;
            close $fh;
            sh q(rm init.d/script.tt);
            sh qq(chmod +x init.d/$merged_config{prog_name});
        }
        {
            unless (-e 'logrotate.d/logrotate.tt') {
                sh q(mkdir -p logrotate.d);
                sh q(curl -s -o logrotate.d/logrotate.tt https://raw.githubusercontent.com/masakyst/centos-initd-psgi-template/master/logrotate.tt);
            }
            my $output_logrotate;
            $tt->process('logrotate.d/logrotate.tt', \%merged_config, \$output_logrotate);
            open my $fh, '>', 'logrotate.d/'.$merged_config{appname} or die qw/Can't open file: $!/;
            print $fh $output_logrotate;
            close $fh;
            sh q(rm logrotate.d/logrotate.tt);
        }
    };

};


namespace deploy => sub {

    desc 'deploy app on production server';
    task install => sub {
        sh q(carton exec cinnamon --config=deploy.pl production install);
    };    

    desc 'start service on production server';
    task start => sub {
        sh q(carton exec cinnamon --config=deploy.pl production start);
    };    

    desc 'stop service on production server';
    task stop => sub {
        sh q(carton exec cinnamon --config=deploy.pl production stop);
    };    

    desc 'restart service on production server';
    task restart => sub {
        sh q(carton exec cinnamon --config=deploy.pl production restart);
    };    

    desc 'app status on production server';
    task status => sub {
        sh q(carton exec cinnamon --config=deploy.pl production status);
    };    

};


